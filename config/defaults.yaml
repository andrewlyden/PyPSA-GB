# ══════════════════════════════════════════════════════════════════════════════
# PyPSA-GB Default Configuration
# ══════════════════════════════════════════════════════════════════════════════
# This file defines DEFAULT values inherited by all scenarios.
# Scenarios in scenarios.yaml only need to specify values that DIFFER from these.
# ══════════════════════════════════════════════════════════════════════════════

# ──────────────────────────────────────────────────────────────────────────────
# TIME & RESOLUTION
# ──────────────────────────────────────────────────────────────────────────────
timestep_minutes: 60              # 60 = hourly, 30 = half-hourly
voll: 6000.0                      # Value of Lost Load (£/MWh)

# ──────────────────────────────────────────────────────────────────────────────
# DATA SOURCES
# ──────────────────────────────────────────────────────────────────────────────
# Temporal profile source for demand (annual totals always from FES for future scenarios)
# Options:
#   "ESPENI"    - Historical half-hourly GB demand (recommended, uses demand_year)
#   "eload"     - eLOAD model hourly profile (2010 or 2050 via profile_year)
#   "desstinee" - DESSTINEE model hourly profile (2010 or 2050 via profile_year)
# 
# For eload/desstinee, profile_year auto-selects (2050 if modelled_year >= 2040, else 2010)
demand_timeseries: "ESPENI"

# ──────────────────────────────────────────────────────────────────────────────
# SOLVER CONFIGURATION
# ──────────────────────────────────────────────────────────────────────────────
solver:
  name: "gurobi"                  # Options: gurobi, highs, glpk, cplex
  threads: 4
  method: 2                       # 0=primal, 1=dual, 2=barrier
  crossover: 0                    # 0=disabled (faster), -1=auto (enables crossover)
  BarHomogeneous: 1               # 1=enable homogeneous barrier (handles numerical issues)
  BarConvTol: 1.e-4               # Relaxed for numerical stability with large storage
  FeasibilityTol: 1.e-4           # Relaxed for numerical stability with large storage
  OptimalityTol: 1.e-4            # Relaxed for numerical stability with large storage
  NumericFocus: 3                 # 0-3, higher = more careful numerics (3=max)
  ScaleFlag: 2                    # 0-3, automatic scaling (2=aggressive)
  DualReductions: 0               # 0=disable (clearer error messages)
  BarIterLimit: 200               # Increase from default 1000 iterations

# ──────────────────────────────────────────────────────────────────────────────
# OPTIMIZATION MODE
# ──────────────────────────────────────────────────────────────────────────────
# LP (Linear Programming):    Fast (~minutes), no unit commitment
# MILP (Mixed-Integer LP):    Slow (~hours), full unit commitment constraints
solve_mode: "LP"                # Options: "LP" or "MILP"

# ──────────────────────────────────────────────────────────────────────────────
# CLUSTERING (disabled by default)
# ──────────────────────────────────────────────────────────────────────────────
clustering:
  enabled: false
  aggregate_components:
    enabled: false
    include_storage_units: false      # Aggregate storage units when possible
    include_loads: false               # Aggregate loads per bus after clustering
    include_stores: false           # Aggregate Store components (rarely used)

# ──────────────────────────────────────────────────────────────────────────────
# SOLVE PERIOD (full year by default)
# ──────────────────────────────────────────────────────────────────────────────
solve_period:
  enabled: false                  # Set true to solve subset of year

# ──────────────────────────────────────────────────────────────────────────────
# TRANSMISSION CONSTRAINTS
# ──────────────────────────────────────────────────────────────────────────────
# For detailed networks (ETYS), actual line ratings may be too restrictive.
# These settings allow relaxing transmission constraints for feasibility.
transmission:
  # Minimum line capacity in MVA (lines below this are set to this value)
  min_line_s_nom: 0               # 0 = use actual ratings
  # Minimum transformer capacity in MVA  
  min_transformer_s_nom: 0        # 0 = use actual ratings
  # Scaling factor for all line/transformer capacities (1.0 = no change)
  capacity_scale: 1.0             # 1.0 = no scaling (use clustering instead)

# ──────────────────────────────────────────────────────────────────────────────
# ETYS NETWORK UPGRADES (ETYS network model only)
# ──────────────────────────────────────────────────────────────────────────────
# Applies planned network infrastructure upgrades from ETYS Appendix B 2023.
# Includes circuit additions/removals, transformer changes, and new HVDC links.
# Only applies when network_model: "ETYS"
etys_upgrades:
  enabled: true                  # Set false to not apply network upgrades
  # Year through which to apply upgrades (null = use modelled_year)
  # Example: If modelled_year is 2035, apply all upgrades through 2035
  upgrade_year: null              # null, or specific year like 2030

# ──────────────────────────────────────────────────────────────────────────────
# LOGGING
# ──────────────────────────────────────────────────────────────────────────────

logging:
  level: "INFO"                     # DEBUG, INFO, WARNING, ERROR, CRITICAL
  log_to_file: true
  log_directory: "logs"

# ──────────────────────────────────────────────────────────────────────────────
# DEMAND DISAGGREGATION (optional, disabled by default)
# ──────────────────────────────────────────────────────────────────────────────
# When enabled in a scenario, components are disaggregated from total demand.
# Defaults prefer FES-based fractions and GSP spatial allocation for future scenarios.

demand_disaggregation:
  enabled: false
  components:
    - name: "heat_pumps"
      allocation_method: "fes_gsp"
      use_fes_fraction: true
      min_gwh_threshold: 0.01
    - name: "electric_vehicles"
      allocation_method: "fes_gsp"
      use_fes_fraction: true
      min_gwh_threshold: 0.01

# ──────────────────────────────────────────────────────────────────────────────
# DEMAND-SIDE FLEXIBILITY
# ──────────────────────────────────────────────────────────────────────────────
# Model demand-side flexibility from heat pumps, EVs, and demand response.
# Each flexibility type can be independently enabled/disabled.
# Requires demand_disaggregation to be enabled for HP and EV components.

demand_flexibility:
  # Master switch - must be true for any flexibility to be modeled
  enabled: false

  # HEAT PUMP FLEXIBILITY (independently toggleable)
  # Requires heat_pumps in demand_disaggregation.components
  heat_pumps:
    enabled: false                    # Independent toggle for HP flexibility
    mode: "MIXED"                     # TANK, COSY, or MIXED (use mix shares below)
    flex_share: 0.2                   # Fraction of HP demand that is flexible
    mix:
      tank_share: 0.5                 # Fraction of flexible HP demand using TANK mode
      cosy_share: 0.5                 # Fraction of flexible HP demand using COSY mode
    # Spatial allocation
    urban_weight: 1.5                      # Power exponent for urban-weighted allocation (>1 = more urban)
    peak_thermal_kw_per_dwelling: 10.0     # Assumed peak thermal output per dwelling (kW)
    link_sizing_margin: 1.5                # Margin factor for HP link capacity (1.5 = 50% headroom)
    # COSY mode: Pre-heating using building thermal mass
    cosy:
      morning_window: ["07:00", "09:00"]   # Morning pre-heat window
      evening_window: ["17:00", "19:00"]   # Evening pre-heat window
      max_temp_deviation_celsius: 2.0      # Max comfort deviation (±°C)
      thermal_mass_hours: 0.3              # Hours of heating that can be stored in building fabric
                                           # Based on ~2.7 kWh/dwelling at ~10 kW peak thermal
      standing_loss_per_hour: 0.05         # Building thermal loss rate (5%/hour, faster than tank)
    # TANK mode: Hot water tank storage
    tank:
      volume_liters: 200              # Average tank volume
      temp_range: [50, 65]            # Min/max temperature (°C)
      standing_loss_per_hour: 0.01    # Heat loss fraction per hour (1%)
      heater_power_kw: 3.0            # Immersion heater power

  # ELECTRIC VEHICLE FLEXIBILITY (independently toggleable)
  # Requires electric_vehicles in demand_disaggregation.components
  # 
  # EV flexibility modeling uses FES building blocks:
  #   - Dem_BB006: EV domestic charging demand (GWh)
  #   - Dem_BB007: EV non-domestic charging demand (GWh)
  #   - Srg_BB005: V2G availability (MW) - used for V2G and MIXED modes
  #   - Srg_BB007a: Smart charging availability (MW) - used for MIXED mode
  #
  # Without flexibility, EVs are simple Load components with evening-peak profile.
  # With flexibility, Store + Link components enable charging optimization.
  electric_vehicles:
    enabled: false                    # Independent toggle for EV flexibility
    tariff: "MIXED"                     # GO, INT, V2G, or MIXED (see modes below)
    
    # Flex share: Fraction of EV demand that participates in flexibility
    # Controls DEMAND SPLIT: 20% → smart charging, 80% → dumb loads
    # 1.0 = all EVs are flexible, 0.2 = only 20% of EV demand uses smart charging
    flex_share: 0.2

    # Fleet characteristics (affect storage/charger sizing)
    battery_capacity_kwh: 60.0        # Average EV battery size (kWh)
    charge_efficiency: 0.90           # Grid-to-battery efficiency
    flexibility_participation: 0.10   # Fraction of fleet participating in smart charging

    # Spatial allocation and fleet sizing
    urban_weight: 2.0                 # Power exponent for urban-weighted allocation (>1 = more urban)
    energy_per_vehicle_kwh_per_day: 10.0  # Assumed daily energy consumption per vehicle (kWh)
    charging_hours_per_day: 4.0       # Assumed charging hours/day (for FES share calculation)
    min_share_threshold: 0.001        # Minimum tariff share to create components
    
    # GO tariff: Octopus Go style fixed night window
    # Simple time-of-use tariff with cheap overnight rates
    # Charging is incentivized during window via cost differential,
    # but charging CAN still occur outside window if needed (at higher cost)
    go:
      window: ["00:00", "04:00"]      # Cheap charging window (4 hours)
      window_cost: 0.0                # Marginal cost during cheap window (£/MWh)
      offpeak_cost: 100.0             # Marginal cost outside window (£/MWh)
    
    # INT tariff: Intelligent/smart charging - fully optimizable
    # Charging can be shifted across all hours when plugged in
    int:
      min_soc: 0.20                   # Minimum SOC (range anxiety buffer)
      target_departure_soc: 0.80      # Target SOC at departure time (7am)
      charger_power_kw: 7.0           # Home charger power (kW)
    
    # V2G: Vehicle-to-grid bidirectional
    # EVs can discharge back to grid for additional flexibility
    # V2G capacity sources (in order of priority):
    #   1. FES Srg_BB005 if use_fes_capacity: true (distributed by EV demand)
    #   2. Calculated from fleet × participation_rate × charger_power
    v2g:
      participation_rate: 0.30        # Fraction of flexible fleet with V2G (if not using FES)
      discharge_efficiency: 0.90      # Battery-to-grid efficiency
      max_discharge_soc: 0.80         # Don't discharge below 20% SOC
      degradation_cost_per_mwh: 50.0  # Battery wear cost (£/MWh)
      use_fes_capacity: true          # Use FES Srg_BB005 V2G capacity (17.9 GW for HT 2035)
    
    # MIXED mode: Split EV fleet across GO, INT, and V2G tariffs
    # This provides a realistic mix of charging behaviors
    # Shares are calculated from FES data or can be manually overridden
    mixed:
      # Share calculation mode:
      #   "fes" - Use FES building blocks to calculate shares (recommended)
      #   "manual" - Use the shares defined below
      mode: "fes"
      
      # Manual share overrides (used if mode: "manual" or FES data unavailable)
      # Must sum to 1.0
      go_share: 0.30                  # 30% on Octopus Go style (fixed window)
      int_share: 0.50                 # 50% on intelligent smart charging
      v2g_share: 0.20                 # 20% with V2G capability
      
      # FES-derived share options (used if mode: "fes")
      # V2G share is derived from FES Srg_BB005 (V2G MW) / total EV charging capacity
      # INT share is the remaining smart charging capacity from FES Srg_BB007a
      # GO share is the remainder (non-smart charging EVs)
      fes_share_overrides:
        # Optional: Override specific shares even in FES mode
        # Uncomment to fix a share while others adjust
        # go_share: 0.20              # Force 20% GO, rest from FES
        # v2g_share: null             # null = use FES value
    
    # Availability profile parameters (from GB traffic patterns)
    # EVs available for charging when parked (inversely related to traffic)
    availability:
      avail_max: 0.95                 # Max fraction plugged in (overnight)
      avail_mean: 0.80                # Mean fraction plugged in
      departure_hour: 7               # Morning departure time for DSM constraint

  # EVENT RESPONSE / DEMAND RESPONSE (independently toggleable)
  # Saving Sessions style demand response events - DOMESTIC DSR only
  # This represents households reducing demand during peak periods
  event_response:
    enabled: false                    # Independent toggle for event response
    
    # EVENT FREQUENCY MODES (choose one):
    #   "regular"  - 2 events/week YEAR-ROUND (baseline flexibility, constant participation)
    #   "winter"   - 5 events/week Oct-Mar ONLY, 0 events Apr-Sep (crisis mode, winter peaks)
    #   "both"     - 2 events/week year-round + extra 5 events/week during Oct-Mar (realistic mix)
    mode: "both"
    events_per_week_regular: 2          # Events per week in regular/both modes
    events_per_week_winter: 5           # Events per week in winter/both modes
    
    # Event Window Options (choose one, realistic alternatives):
    #   ["17:00", "19:00"]  - Evening peak only (tight window, high utilization)
    #   ["16:00", "20:00"]  - Extended evening (covers demand ramp-up)
    #   ["07:00", "22:00"]  - Full day flexibility (most realistic for modern DSR)
    event_window: ["07:00", "22:00"]  # Default: evening peak window
    
    dsr_capacity_mw: null             # User-defined domestic DSR capacity (MW)
    # If dsr_capacity_mw is set: Uses that value directly
    # If null: Calculates from participation_rate * max_reduction_fraction * demand
    participation_rate: 0.33          # Fallback: participation rate (33%)
    max_reduction_fraction: 0.10      # Fallback: max demand reduction per event (10%)
    marginal_cost: 100.0              # DSR incentive payment (£/MWh) - high cost = only dispatch if needed
    winter_months: [10, 11, 12, 1, 2, 3]  # Oct-Mar for winter mode
